cd /c/Users/srika/devsecops/shellscript/Notes/Terraform_notes/

Remote state
==============
--> state is used by terraform. usually we should not touch state file. 

--> We should secure state file from accidental changes.  --> it means unfortunately keys press avavtum and delete avvatum with our interruption  .  

1st person completed infra, state is in his local.. ---> state file anedhi 1st person laptop lone vunttadhi,
2nd person want to do changes, so here 1st person emi chesadu ani 2nd person ki teliyadhu so in this case, he initialise terraform, he will plan and he will apply

so here mainly 2 thigs will happen
================
1. either duplicate resources will be created
2. error while creating resources or else we will get error like saying that already exists

--> so ec2 instaces enni ayina create cheyachu, but sg matram same name tho malli create cheyalemu manaki error vastundhi like already exist ani

---> what is the solution while mutliple persons are work chestunte ----> simple solu is centralised state or block or room

--> here we have dig state.drwio..... for detailed dig matter will be available in my own doc can u see there


we must keep state file in remote location while working in collaboration environment for security and preventing duplicate resources and errors, when multiple members( team members) are working together


--> state file should be locked when terraform is doing something, so for that others can't apply the changes.

--> everytool ki oka starage vunttadhi like aws ki s3 ani azure ki Blob... emi lekapothe terraform own ga storage create chestundhi..

--> drive lo manam ela folder create chetamo ala aws lo s3 bucket create cheyali.. for starage purpose our state file....
--> here entire aws s3 bucket name should be unique ga vundali...

--> dsoaws-remote-state --> s3 bucket create chesam next aa file location or path access terraform ki ichhi state files ni akkada store chesuko ani cheppali...

terrform aws s3 remote starge ---> https://developer.hashicorp.com/terraform/language/backend/s3 --> here we will get backend code for state file storing

--> so ideally we have to use remote state files in real time projects........

---> Here remote state folder has been created....
Syntax
-======

backend "s3" { # backend ante remote store ani anukovali
    bucket = "dsoaws-remote-state"
    key    = "remote-state-demo" # so here keys must be not for the same for all, u have to set name as per the requirement like dev ithe dev name and prod ithe prod name 
    region = "us-east-1"
    use_lockfile = true
    encrypt = true --> it means unauthorised person file tisukuna no use bcz data has been encrypt....

locals
=======
--> here local folder has been created

--> so here variable.tf file access andhariki ivvakudadhu or else small company run chestunte vallu as per the budget vallu t3.micro ni use chestaru manam variable.tf file ki access iste  team vallu dhani change chesi use chesukuntaru so we aren't give access to them.. for that we need to create local.tf for restrict purpose..

--> local.tf introduced by  terraform so we can't do any changes.. inside file.

locals are like variables but it has many extra capabilities

1. variables can be overridden, locals can't be overridden ( re-write by someone)
2. we can use variables inside locals. but we can't use one variable in another variable

--> ala use cheste error vastundhi u can see in own doc error page
EX:-

variable "common_name" {
    default = "${var.project}-${var.environment}"
}


3. you can store expressions or functions inside locals block and reuse them whenever required

mysql catalogue cart user --ila same names vunttai for different projects so we need to get unique while creating resources....... like as below we have to set names for creation of resoures.... or server names or instance names like as below

roboshop-catalogue --------> naming conversion for uniqueness kosam
roboshop-dev-catalogue --------> naming conversion for uniqueness kosam --> small company one aws account vunte like these need to create resources with unique name....
roboshop-qa-catalogue --------> naming conversion for uniqueness kosam


 ec2_tags = merge(
      var.common_tags,
      {
        Name = "${local.common_name}-local-demo"
      }
    )
# so here var.common_tags anedhi oka map1 and  Name = "${local.common_name}-local-demo" anedhi map2 so merge fun use chesinappudu antha union ayyipothadhi...

Result
========
"Name"      = "sriroboshop-dev-local-demo"

 ---> name   = "${local.common_name}-sg-terraform-allow" ... ikkada cheptunam roboshop kosam create chesina sg ani...

--> need to know what is the difference b/w local and variables


dynamic block ----> not much use in real time we need to know basic matter about that
==============
loops inside terraform
	count based
	for_each
	dynamic

---> dynamic folder has been created
	
22 8080 80 3306 27017 6379 5672
--> Here multiple ports ni servers ki add chese time lo we need write more ingress blocks like 22 oka block and 80 ki inkokati so ala repeated ithe code length increase

--> https://developer.hashicorp.com/terraform/language/expressions/dynamic-blocks ---> for detailed syntax.....
--> oka block multiple times repeated avuthunte we need to use dynamic......



Provisioners
============

---> Provison folder has been created.... 

terraform is creating instance, if we want to configure terraform is allowing to run few scripts

--> basically provisioning means it will change position to another position... 
--> once incident create chesina tharivatha emi cheyali ante we have to options like as below

1. local-exec  ----> terraform cmd ekkada ithe vundho or run cheestunte  adi local
EX: here terraform plan and apply cmds windows lo run cheste... windows is local avuthundhi....Linux lo run cheste then Linux is local of the terraform..

---->Basically server creation done after server configuration ki ansible ni run cheyali so dhaniki private ip ivvali

--> command = " echo instances created " .... for this output is 
# aws_instance.terraform (local-exec): instances created


provisioner "local-exec"{
      command = "echo ${self.private_ip} > inventory"
      #command = " echo instances created "
      #on_failure = continue # see notes
    }
---> so here provisions by default terraform apply chesina tharuvatha run avuthudiii, 
------> on_failure = continue  it is use like oka vela ip address inventory file lo rayalekapothe provisioner ila cheptundhi the above ec2 resource also failed ni.. so to overcome this issue u need to add on_fail ane option ni add cheste  then provision says like ec2 resources no fail.......


---> destroy timem lo kuda run avvalante we have to write the below code

   provisioner "local-exec"{
      command = "echo Instance is destroyed"
      when    = destroy
    }
--> Destroy ani ivvaka pothe adhi by default creation time anukoni manaki print avuthundhi....

2. remote-exec ---> so here local tho server or ec2 instance crate chesi serve loki login ayyi akkada some cmds or actions perform excute chese dhani remote exce antam

ansible-playbook -i inventory playbook.yaml ----> ila ansible ki connect cheyachu for server configuration ki